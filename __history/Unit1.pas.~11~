unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, Data.DB,
  mySQLDbTables;

type
  TForm1 = class(TForm)
    GroupBox1: TGroupBox;
    ListBoxUsers: TListBox;
    Label1: TLabel;
    Label2: TLabel;
    DateTimePickerMeasur: TDateTimePicker;
    ComboBoxTime: TComboBox;
    Label3: TLabel;
    EditNumber: TEdit;
    Label4: TLabel;
    EditName: TEdit;
    Label5: TLabel;
    Label6: TLabel;
    EditCity: TEdit;
    EditStreet: TEdit;
    Label7: TLabel;
    EditHouse: TEdit;
    Label8: TLabel;
    EditFlat: TEdit;
    Label9: TLabel;
    EditEntrance: TEdit;
    Label10: TLabel;
    EditFloor: TEdit;
    Label11: TLabel;
    MemoComment: TMemo;
    Button1: TButton;
    MySQLDatabase1: TMySQLDatabase;
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;
  DataSourceMeasur : TDataSource;
  MySQLQueryMeasur : TMySQLQuery;

implementation

{$R *.dfm}

procedure TForm1.Button1Click(Sender: TObject);
var User,Client,Manager,City,Street,House,Flat,
Floor,Entrance,Status,Date,Time,DateNow,Comment : String;

begin
 if Length(EditName.Text) > 0 then begin
 if Length(EditStreet.Text) > 0 then begin
  if Length(EditHouse.Text) > 0 then begin


    // search user
   user := ListBoxUsers.Items[ListBoxUsers.ItemIndex]; // selected user
   MySQLQueryMeasur := TMySQLQuery.Create(Application);
   MySQLQueryMeasur.Database := MySQLDatabase1;
   MySQLQueryMeasur.SQL.Text := 'SELECT idUser FROM ListUser WHERE UserName = "'+user+'"';
   MySQLQueryMeasur.Active := true;
   user := MySQLQueryMeasur.FieldByName('idUser').AsString;
    // search client
   Client := EditNumber.Text;
   MySQLQueryMeasur := TMySQLQuery.Create(Application);
   MySQLQueryMeasur.Database := MySQLDatabase1;
   MySQLQueryMeasur.SQL.Text := 'SELECT ClientID FROM ListClientNumber WHERE ClientNumber = "'+Client+'"';
   MySQLQueryMeasur.Active := true;
   Client := MySQLQueryMeasur.FieldByName('ClientID').AsString;

   Manager := '1'; // add current user
   City := EditCity.Text;
   Street := EditStreet.Text;
   House := EditHouse.Text;
   Flat := EditFlat.Text;
   Entrance := EditEntrance.Text;
   Floor := EditFloor.Text;
   Status := 'Замер назначен';
   Date :=   FormatDateTime('yyyy-mm-dd',DateTimePickerMeasur.Date); // Datetostr(DateTimePickerMeasur.Date);
   Time := ComboBoxTime.Items[ComboBoxTime.ItemIndex];  // selected current time
   DateTimePickerMeasur.Date := now;
   DateNow :=FormatDateTime('yyyy-mm-dd',DateTimePickerMeasur.Date);
   Comment := MemoComment.Text;

   MySQLQueryMeasur := TMySQLQuery.Create(Application);
   MySQLQueryMeasur.Database := MySQLDatabase1;
   MySQLQueryMeasur.SQL.Text := 'INSERT INTO `listmeasurements`'+
   '( `ClientID`, `ManagerID`, `UserID`, `MeasurementsCity`,'+
   '`MeasurementsStreet`, `MeasurementsHouse`, `MeasurementsFlat`, `MeasurementsEntrance`,'+
   ' `MeasurementsFloor`, `MeasurementsStatus`, `ListMeasurementsDate`, `ListMeasurementsTime`,'+
   ' `ListMeasurementsDateAdd`, `ListMeasurementsComment`, `MeasurementsVisible`) VALUES'+
   '("'+client+'", "'+manager+'", "'+user+'", "'+city+'", "'+street+'", "'+house+'", "'+flat+'",'+
   ' "'+entrance+'", "'+floor+'", "'+status+'", "'+date+'", "'+time+'", "'+dateNow+'", "'+comment+'",1)';
   MySQLQueryMeasur.ExecSQL;

  end else Showmessage('Введите номер дома');
 end else Showmessage('Введите название улицы');
end else Showmessage('Введите ФИО');


   end;

procedure TForm1.FormCreate(Sender: TObject);
var user:String; i:integer;
begin

   MySQLQueryMeasur := TMySQLQuery.Create(Application);
   MySQLQueryMeasur.Database := MySQLDatabase1;
   MySQLQueryMeasur.SQL.Text := 'SELECT * FROM ListUser';
   MySQLQueryMeasur.Active := true;

   while not MySQLQueryMeasur.Eof do
      begin
       user := MySQLQueryMeasur.FieldByName('UserName').AsString;
       ListBoxUsers.Items.Add(user);
       MySQLQueryMeasur.Next;

   end;
   ListBoxUsers.ItemIndex := 0;
   ComboBoxTime.ItemIndex := 0;


end;

end.
